# Inline data here - skip to about Line 460 for code
library(dplyr)
library(lubridate)
library(shiny)
library(ggplot2)

daily_runs = data.frame(
  dates = ymd(
    c(
      "2018-10-28",
      "2018-10-29",
      "2018-10-30",
      "2018-10-31",
      "2018-11-01",
      "2018-11-02",
      "2018-11-03",
      "2018-11-04",
      "2018-11-05",
      "2018-11-06",
      "2018-11-07",
      "2018-11-08",
      "2018-11-09",
      "2018-11-10",
      "2018-11-11",
      "2018-11-12",
      "2018-11-13",
      "2018-11-14",
      "2018-11-15",
      "2018-11-16",
      "2018-11-17",
      "2018-11-18",
      "2018-11-19",
      "2018-11-20",
      "2018-11-21",
      "2018-11-22",
      "2018-11-23",
      "2018-11-24",
      "2018-11-25",
      "2018-11-26",
      "2018-11-27",
      "2018-11-28",
      "2018-11-29",
      "2018-11-30",
      "2018-12-01",
      "2018-12-02",
      "2018-12-03",
      "2018-12-04",
      "2018-12-05",
      "2018-12-06",
      "2018-12-07",
      "2018-12-08",
      "2018-12-09",
      "2018-12-10",
      "2018-12-11",
      "2018-12-12",
      "2018-12-13",
      "2018-12-14",
      "2018-12-15",
      "2018-12-16",
      "2018-12-17",
      "2018-12-18",
      "2018-12-19",
      "2018-12-20",
      "2018-12-21",
      "2018-12-22",
      "2018-12-23",
      "2018-12-24",
      "2018-12-25",
      "2018-12-26",
      "2018-12-27",
      "2018-12-28",
      "2018-12-29",
      "2018-12-30",
      "2018-12-31",
      "2019-01-01",
      "2019-01-02",
      "2019-01-03",
      "2019-01-04",
      "2019-01-05",
      "2019-01-06",
      "2019-01-07",
      "2019-01-08",
      "2019-01-09",
      "2019-01-10",
      "2019-01-11",
      "2019-01-12",
      "2019-01-13",
      "2019-01-14",
      "2019-01-15",
      "2019-01-16",
      "2019-01-17",
      "2019-01-18",
      "2019-01-19",
      "2019-01-20",
      "2019-01-21",
      "2019-01-22",
      "2019-01-23",
      "2019-01-24",
      "2019-01-25",
      "2019-01-26",
      "2019-01-27",
      "2019-01-28",
      "2019-01-29",
      "2019-01-30",
      "2019-01-31",
      "2019-02-01",
      "2019-02-02",
      "2019-02-03",
      "2019-02-04",
      "2019-02-05",
      "2019-02-06",
      "2019-02-07",
      "2019-02-08",
      "2019-02-09",
      "2019-02-10",
      "2019-02-11",
      "2019-02-12",
      "2019-02-13",
      "2019-02-14",
      "2019-02-15",
      "2019-02-16",
      "2019-02-17",
      "2019-02-18",
      "2019-02-19",
      "2019-02-20",
      "2019-02-21",
      "2019-02-22",
      "2019-02-23",
      "2019-02-24",
      "2019-02-25",
      "2019-02-26",
      "2019-02-27",
      "2019-02-28",
      "2019-03-01",
      "2019-03-02",
      "2019-03-03",
      "2019-03-04",
      "2019-03-05",
      "2019-03-06",
      "2019-03-07",
      "2019-03-08",
      "2019-03-09",
      "2019-03-10",
      "2019-03-11",
      "2019-03-12",
      "2019-03-13",
      "2019-03-14",
      "2019-03-15",
      "2019-03-16",
      "2019-03-17",
      "2019-03-18",
      "2019-03-19",
      "2019-03-20",
      "2019-03-21",
      "2019-03-22",
      "2019-03-23"
    )
  ),
  times = c(
    40.97,
    38.47,
    38.67,
    39.32,
    0,
    38.28,
    57.07,
    37.77,
    38.42,
    0,
    39.77,
    46.03,
    0,
    26.93,
    0,
    39.38,
    42.52,
    37.78,
    41.15,
    61.93,
    36.55,
    0,
    42.28,
    40.75,
    39.27,
    42.4,
    38.38,
    60.98,
    0,
    67.23,
    39.65,
    39.3,
    33.93,
    48.02,
    38.7,
    0,
    42.18,
    56.77,
    46.67,
    44.52,
    48.07,
    75.72,
    0,
    47.85,
    45.68,
    47.5,
    57.55,
    43.3,
    77.83,
    0,
    47.03,
    0,
    49.47,
    60.43,
    49.62,
    74.02,
    0,
    45.03,
    47.03,
    55.55,
    44.57,
    42.33,
    77.07,
    0,
    53.87,
    52.17,
    47.57,
    85.63,
    48.45,
    64.13,
    0,
    53.02,
    47.2,
    53.58,
    110.3,
    48.82,
    55.1,
    53.7,
    0,
    89.73,
    46.98,
    67.97,
    47.95,
    44.5,
    0,
    40.05,
    44.32,
    57.05,
    44.02,
    43.78,
    70.02,
    0,
    59.78,
    63.18,
    59.57,
    108.55,
    47.02,
    49.45,
    35.12,
    52.43,
    60.03,
    45.03,
    45.75,
    43.62,
    56.45,
    0,
    67.72,
    65.02,
    128.92,
    49.5,
    53.87,
    46.85,
    0,
    60.73,
    58.7,
    59.52,
    63.2,
    58.23,
    81.07,
    0,
    51.27,
    51.45,
    77.95,
    63.23,
    125.4,
    62.78,
    0,
    61.88,
    60.43,
    79.52,
    67.43,
    61.52,
    106.85,
    0,
    45.72,
    52.32,
    53.02,
    63.12,
    51.7,
    83.1,
    0,
    63.52,
    61.48,
    56.03,
    67.02,
    63.15,
    142.73
  ),
  distances = c(
    5.01,
    5.03,
    5.01,
    5.52,
    0,
    5.01,
    7.51,
    5.13,
    5.2,
    0,
    5.01,
    6.47,
    0,
    3.52,
    0,
    5.12,
    5.32,
    5.06,
    5.6,
    8.01,
    5.01,
    0,
    5.6,
    5.33,
    5.05,
    5.51,
    5.06,
    8.1,
    0,
    9,
    5.01,
    5.14,
    4.52,
    6.56,
    5.1,
    0,
    5.58,
    7.51,
    6.31,
    6.24,
    6.11,
    10.01,
    0,
    6.22,
    6.21,
    6.11,
    7.61,
    5.53,
    10.08,
    0,
    6.24,
    0,
    6.75,
    8.28,
    6.84,
    10.23,
    0,
    6.3,
    6.26,
    7.53,
    6.15,
    5.58,
    10.51,
    0,
    7.13,
    7.32,
    6.59,
    12.01,
    6.56,
    9.01,
    0,
    7.21,
    6.51,
    7.25,
    15.01,
    6.57,
    7.54,
    7.35,
    0,
    12.05,
    6.41,
    9.06,
    6.57,
    6.32,
    0,
    5.39,
    6.21,
    8.03,
    6.12,
    6.32,
    10.11,
    0,
    8.62,
    9.15,
    8.3,
    15.25,
    6.42,
    6.61,
    4.85,
    7.31,
    8.18,
    6.05,
    6.14,
    6.01,
    7.51,
    0,
    9.15,
    9.26,
    18.02,
    6.6,
    7.07,
    6.23,
    0,
    8.26,
    9.23,
    8.24,
    8.54,
    8.28,
    11.51,
    0,
    7.01,
    7.13,
    11.01,
    9.5,
    17.02,
    8.52,
    0,
    8.5,
    8.26,
    12.13,
    9.01,
    8.12,
    15.32,
    0,
    6.56,
    6.66,
    7.11,
    9.06,
    7.17,
    11.6,
    0,
    9.01,
    9.01,
    8.15,
    9.33,
    8.75,
    20.11
  )
)

# Precompute groupings by week, month
daily_runs$weeks <-
  floor((daily_runs$dates - daily_runs$dates[1]) / 7)
daily_runs$months <- month(daily_runs$dates)

weekly_runs <-
  daily_runs %>%
  group_by(weeks) %>%
  summarize(
    # Compute "end_dates" first. Otherwise, R tries to use the new "dates"
    # column for the right-hand side
    end_dates = max(dates),
    dates = min(dates),
    times = sum(times),
    distances = sum(distances)
  )

monthly_runs <-
  daily_runs %>%
  group_by(months) %>%
  summarize(
    end_dates = max(dates),
    dates = min(dates),
    times = sum(times),
    distances = sum(distances)
  ) %>%
  arrange(dates)
# There's a little bit of data for October, which we exclude for the month view
monthly_runs <- monthly_runs[-1,]

shinyServer(function(input, output) {
  # Select the “runs” data based on aggregation level
  runs <- reactive({
    switch(
      input$grouping,
      daily = daily_runs,
      weekly = weekly_runs,
      monthly = monthly_runs
    )
  })
  
  # Generate the plot
  output$run_plot <- renderPlot({
    graph <- ggplot(data = runs(),
                    mapping = aes(x = dates,
                                  y = switch(input$plot_value,
                                             time = times,
                                             distance = distances,
                                             pace = times / distances))) +
      xlab("Date") +
      ylab(switch(input$plot_value,
                  time = "Time (minutes)",
                  distance = "Distance (miles)",
                  pace = "Pace (min / mile)"))
    
    if ("linear" %in% input$curves) {
      graph <- graph +
        geom_smooth(method = "lm", color = "red")
    }
    
    # Scale x to get a better curve
    if ("exp" %in% input$curves) {
      graph <- graph +
        geom_smooth(method = "lm", formula = "y ~ exp(x / 100)", color = "green")
    }
      
    graph + geom_point(color = "blue")
  })
  
  # Generate table
  # We clean up the data frame somewhat for display by removing undesired columns,
  # converting dates so they display in human-readable format, giving more display-friendly
  # column names, and making sure columns appear in a specific order.
  output$run_table <- renderTable({
    data <- runs()
    data$weeks <- NULL
    data$months <- NULL
    data$dates <- as.character(data$dates)
    
    data <- rename(data,
                    "Time (minutes)" = times,
                    "Distance (miles)" = distances)
    
    if (input$grouping == "weekly" || input$grouping == "monthly") {
      data$end_dates <- as.character(data$end_dates)
      data <- rename(data,
                     "Start Date" = dates,
                     "End Date" = end_dates)
      # Use a select so the table columns display in the specified order
      data %>% select("Start Date", "End Date", "Time (minutes)", "Distance (miles)")
    } else {
      data <- rename(data,  "Date" = dates)
      data
    }
  }, align = "c")
  
  output$table_label <- reactive({
    switch(input$grouping,
           daily = "A summary of daily running volume, in terms of time and distance",
           weekly = "A summary of weekly running volume, in terms of time and distance. Weeks start with the listed date",
           monthly = "A summary of monthly running volume, in terms of time and distance")
  })
})
